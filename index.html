<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>PacBike</title>
        <style>
        </style>
    </head>
    <body>
        <div id="other stuff">
            Score:
            <div id="currentScore" style="display:inline-block;">
            </div>
        </div>

        <div id="playground">
            <div id ="splash">
                <a id="start">Start</a>
                <div id="loadbar" style="background: 000; height: 32px; overflow: visible;"><span id="loadtext" style="color: red"></span></div>
            </div>
        </div>

        <script language="JavaScript" type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.js"></script>
        <script language="JavaScript" type="text/javascript" src="jquery.gamequery-0.7.1.js"></script>
        <script>
            var tileW = 30;
            var tileH = 30;
            var movingLock = false;
            var ghostRoutes;
            var ghost0route;

            var REFRESH_RATE = 30;
            var playerHit = false;
            var playerW = 30;
            var playerH = 30;
            var player,ghost;
            var SPEEDX = tileW;
            var SPEEDY = tileH;
            // Duration (in ms) to get to the next tile
            var STEP_SPEEDX = 200;
            var STEP_SPEEDY = 200;

            // Generated with gQ's Tiles map editor
            // http://gamequeryjs.com/tools/tilemapeditor/

            var animations = [];
            // Laneways
            animations[0] =  new $.gameQuery.Animation({
                imageURL:      'http://placehold.it/'+tileW+'/0B173B&text=.',
                type:          $.gameQuery.ANIMATION_ONCE,
                numberOfFrame: 1,
                delta:         0,
                rate:          1,
                offsetx:       0,
                offsety:       0
            });
            // Buildings
            animations[1] =  new $.gameQuery.Animation({
                imageURL:      'http://placehold.it/'+tileW+'/0000FF&text=.',
                type:          $.gameQuery.ANIMATION_ONCE,
                numberOfFrame: 1,
                delta:         0,
                rate:          1,
                offsetx:       0,
                offsety:       0
            });
            // Main arteries
            animations[2] =  new $.gameQuery.Animation({
                imageURL:      'http://placehold.it/'+tileW+'/000000&text=.',
                type:          $.gameQuery.ANIMATION_ONCE,
                numberOfFrame: 1,
                delta:         0,
                rate:          1,
                offsetx:       0,
                offsety:       0
            });

             // the tilemap array
            var map = [
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2],
                        [3,2,1,2,2,2,1,2,2,3,1,2,1,2,2,2,2,2,3,1,1,1,1,2,2,2,3,2,1,2,2,2,1,2,1,3,2,2,2,2,2,2,2,2,3,2,2,2,2,2,2,2,2,3,1,2,2,1,2,1,2,2,3,2,2,2,1,2,2,3,3],
                        [3,2,1,2,2,2,1,1,1,3,1,1,1,2,1,2,2,2,3,1,2,1,1,2,2,2,3,1,1,1,1,1,1,1,1,3,2,2,2,2,2,2,1,1,3,2,2,2,2,2,2,2,2,3,1,2,1,1,2,1,1,2,3,2,2,1,1,2,2,2,3],
                        [3,2,2,2,2,1,1,1,2,3,2,1,1,2,1,2,1,2,3,1,1,1,1,2,1,2,3,2,2,1,1,1,1,2,1,3,2,2,2,2,2,1,1,2,3,2,2,2,2,2,2,2,2,3,1,2,1,1,2,1,1,2,3,2,2,1,2,2,2,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,2,2,2,1,2,1,3,2,1,2,1,2,1,1,2,3,2,2,2,2,2,2,2,3,2,1,2,1,1,1,1,1,3,2,2,2,2,2,1,1,2,3,1,1,1,2,1,1,1,1,3,1,2,2,2,2,1,2,2,3,2,2,2,1,1,1,1,3],
                        [3,2,2,2,2,2,1,2,2,3,1,1,2,1,1,1,1,2,3,2,2,1,1,1,2,2,3,1,1,2,1,1,1,1,2,3,2,2,2,2,2,1,1,1,3,1,1,1,1,1,1,1,1,3,1,2,2,2,2,1,2,2,3,2,2,2,2,1,2,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,2,1,2,2,2,2,3,1,2,1,2,2,2,2,2,3,2,2,2,2,2,2,1,3,2,1,1,1,1,1,2,2,3,2,1,2,2,2,2,1,2,3,2,1,2,2,2,1,1,2,3,2,2,1,2,2,2,1,2,3,2,1,1,2,2,2,2,3],
                        [3,1,1,1,1,2,1,2,2,3,1,1,1,2,2,2,2,2,3,2,2,2,2,2,2,1,3,2,1,1,1,2,1,1,1,3,1,1,2,2,1,2,1,2,3,1,1,2,1,1,1,1,2,3,1,2,1,1,2,1,1,2,3,2,2,1,2,1,1,2,3],
                        [3,1,2,2,2,1,1,1,2,3,1,1,1,2,1,2,2,2,3,2,2,2,2,2,2,1,3,2,2,1,1,2,1,1,2,3,2,1,2,2,1,2,1,2,3,2,1,2,1,2,1,1,2,3,2,2,1,1,2,1,2,2,3,1,1,1,2,1,1,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,2,2,2,1,1,2,3,1,2,2,1,1,2,1,2,3,1,2,1,1,1,1,2,3,2,2,1,1,1,1,1,1,3,2,2,1,2,1,1,2,1,3,1,1,1,1,1,1,1,2,3,1,1,1,1,1,2,1,1,3,2,1,1,2,1,2,2,3],
                        [3,2,2,2,2,2,1,1,2,3,1,2,2,1,1,2,1,2,3,1,2,2,2,1,1,1,3,2,1,1,1,2,1,1,1,3,2,2,1,2,1,1,2,1,3,1,1,1,1,1,2,1,1,3,1,1,1,1,1,2,1,1,3,1,1,1,2,1,1,1,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,1,2,2,2,2,2,2,3,2,1,2,2,1,2,2,2,3,2,2,2,2,1,2,1,3,2,2,1,2,2,2,2,2,3,2,2,1,1,1,2,2,2,3,2,2,2,1,1,2,2,2,3,2,2,2,2,2,1,2,2,3,2,1,1,2,1,1,2,3],
                        [3,2,1,2,2,2,2,2,2,3,2,1,2,2,1,2,2,2,3,2,2,1,2,1,2,1,3,2,1,1,2,2,2,2,2,3,1,1,1,1,1,1,2,1,3,1,2,2,1,1,1,1,1,3,1,2,1,2,2,1,2,2,3,2,1,1,1,1,1,2,3],
                        [3,2,1,2,2,2,2,2,2,3,2,1,2,2,1,2,2,2,3,2,2,1,2,1,2,2,3,2,1,1,2,2,1,2,2,3,2,1,1,1,1,1,2,1,3,1,1,1,1,1,2,1,2,3,1,2,1,2,2,1,2,2,3,2,1,1,2,1,1,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,2,2,2,2,2,2,3,2,2,1,1,2,1,1,2,3,2,1,1,2,1,1,1,3,2,2,1,1,2,1,1,2,3,1,1,1,2,1,1,1,1,3,1,1,1,1,2,2,2,2,3,2,1,2,1,1,1,2,2,3,1,1,2,1,1,1,1,3],
                        [3,1,1,1,1,1,1,1,1,3,2,2,1,1,1,1,1,1,3,2,1,2,1,1,2,1,3,2,2,2,2,2,2,1,1,3,2,1,1,2,1,1,1,1,3,2,2,2,1,2,2,2,2,3,2,1,2,1,2,2,2,2,3,2,1,2,1,1,2,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,2,2,2,2,2,2,3,2,2,2,2,2,2,2,2,3,2,2,1,1,2,2,1,3,2,2,2,2,2,2,2,2,3,2,2,2,1,2,1,2,2,3,2,2,1,2,2,2,2,2,3,2,2,1,2,2,2,1,1,3,2,2,2,2,1,2,2,3],
                        [3,2,2,2,2,2,2,2,2,3,2,2,2,2,2,2,2,2,3,2,2,1,1,2,1,1,3,1,1,2,1,1,2,2,1,3,2,2,2,1,2,1,2,1,3,2,2,1,1,1,2,2,2,3,1,2,1,2,2,1,1,2,3,2,2,2,2,1,1,2,3],
                        [3,2,2,2,2,2,2,2,2,3,1,2,2,2,2,2,2,2,3,2,2,1,1,1,1,1,3,2,1,2,1,2,2,1,1,3,2,2,2,1,1,1,2,1,3,2,2,1,1,1,2,1,2,3,2,2,1,2,2,2,1,2,3,2,2,2,2,2,1,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,1,2,2,1,1,2,3,1,1,2,2,1,2,2,2,3,2,2,1,2,2,1,2,3,2,1,2,2,1,2,1,1,3,2,1,1,1,1,1,1,2,3,2,2,1,2,1,1,1,2,3,1,2,1,1,1,1,1,2,3,1,1,1,1,1,1,2,3],
                        [3,2,2,1,2,2,1,1,1,3,1,1,2,2,1,2,2,2,3,2,2,1,2,2,1,2,3,2,1,2,2,2,2,2,1,3,2,1,2,1,1,2,1,2,3,2,2,1,2,2,1,1,2,3,1,2,1,2,2,2,1,1,3,2,2,2,1,2,2,1,3],
                        [3,2,2,1,2,2,1,2,2,3,2,1,2,2,1,2,2,2,3,2,2,1,2,2,1,2,3,2,1,2,2,2,2,2,1,3,2,1,2,1,1,2,1,2,3,2,2,1,2,2,1,1,2,3,1,2,1,2,2,2,1,1,3,2,2,2,1,2,2,1,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]
                    ];

            // Calculating board size based on the tilemap
            var tileNbX = map[0].length;
            var tileNbY = map.length;
            var PLAYGROUND_WIDTH    = tileNbX * tileW;
            var PLAYGROUND_HEIGHT   = tileNbY * tileH;

            // My own wall collision detection function
            var collisionDetect = function(x,y,animationCode){
                var cellx = Math.round(((x+PLAYGROUND_WIDTH/2)*tileNbX)/PLAYGROUND_WIDTH)-1;
                var celly = Math.round(((y+PLAYGROUND_HEIGHT/2)*tileNbY)/PLAYGROUND_HEIGHT);
                // Mapping x and y to a map tile
                console.log("Collision detection with ("+cellx+","+celly+"):"+(map[celly][cellx] == animationCode));
                return map[celly][cellx] == animationCode;
            };

            //
            var plotXFromTile = function(colX){
                var pixel_x = parseInt(colX)*tileW;
                return pixel_x;
            }

            var plotYFromTile = function(rowY){
                var pixel_y = parseInt(rowY)*tileH;
                return pixel_y;
            }

            // Configuring the playground
            $('#playground').playground({
                    height: PLAYGROUND_HEIGHT, 
                    width: PLAYGROUND_WIDTH, 
                    keyTracker: true
                })
                .addTilemap("tilemap", map,  animations, {
                    width: tileW, 
                    height: tileH, 
                    sizex: tileNbX, 
                    sizey: tileNbY
                }).end()
                .addGroup("bikestations", {
                    width: PLAYGROUND_WIDTH, 
                    height: PLAYGROUND_HEIGHT
                }).end()
                .addGroup("pacgums", {
                    width: PLAYGROUND_WIDTH, 
                    height: PLAYGROUND_HEIGHT
                }).end()
                .addGroup("actors",{
                    width: PLAYGROUND_WIDTH, 
                    height: PLAYGROUND_HEIGHT
                })
                    .addGroup("player",{
                        width: playerW, 
                        height: playerH
                    }).end()
                    .addGroup("ghosts",{
                        width: playerW, 
                        height: playerH
                    }).end()
                .end();

            
            // configure the loading bar
            $.loadCallback(function(percent){
                $("#loadBar").width(400*percent);
                $("#loadtext").html(""+percent+"%")
            });
            
            // register the start button and remove the splash screen once the game is ready to starts
            $("#start").click(function(){
                // Game initialisation routine
                var gameInit = function(){
                    $("#splash").remove();

                    // Let the game begin!
                    var pacman = new $.gameQuery.Animation({imageURL: "images/pacman-small.png"});

                    $("#player").addSprite("pacman", {
                        animation: pacman,
                        posx: 0,
                        posy: 0,
                        width: playerW, 
                        height: playerH
                    });

                    // Ghost sprites
                    var ghost = new $.gameQuery.Animation({imageURL: "images/ghost-small.png"});
                    ghost0route = ghostRoutes["0"].l.split(",");
                    var ghost0initPos = ghost0route[0].split("X");

                    $("#ghosts").addSprite("ghost", {
                        animation: ghost,
                        posx: 0, 
                        posy: 0,
                        width: playerW, 
                        height: playerH
                    });

                    // Positionning the pacgums
                    var pacgum = new $.gameQuery.Animation({imageURL: "images/apple-small.png"});
                    var coffee = new $.gameQuery.Animation({imageURL: "images/coffeecup-small.png"});

                    for (var j=0; j < tileNbY ; j+=1)
                    {
                        for (var i=0; i < tileNbX ; i+=1)
                        {
                            if (map[j][i] == 3 && ((i+j)%3==0))
                            {
                                if (Math.random()>0.8){
                                    $("#pacgums").addSprite("coffee-"+i+"_"+j, {
                                        animation: coffee,
                                        posx: (i+1/2)*tileW-25/2, 
                                        posy: (j+1/2)*tileH-24/2,
                                        width: 25,
                                        height: 24
                                    });
                                }
                                else
                                {
                                    $("#pacgums").addSprite("pacgum-"+i+"_"+j, {
                                        animation: pacgum,
                                        posx: (i+1/2)*tileW-20/2, 
                                        posy: (j+1/2)*tileH-20/2,
                                        width: 20,
                                        height: 20
                                    });
                                }
                            }
                        }
                    }

                    $("#player")[0].player = new Player($("#player"));
                    player = $("#player");

                    $("#ghosts")[0].ghost = new Ghost($("#ghosts"));
                    ghost0 = $("#ghosts")[0].ghost;                    

                };

                // Loading the asset file where the ghosts routes are
                $.getJSON("routed_events/assets.json",
                    {},
                    function(json){
                        //
                        if (json)
                        {
                            // Now moving to the detail page with this task id
                            console.log('Asset JSON file loaded: ' + Object.keys(json).length + ' events.');
                            // Global variable holding the routes
                            ghostRoutes = json;
                            // Game init routine
                            $.playground().startGame(gameInit);
                        }
                    }
                );

                function Player(node){
                    var that = this;
                    this.node = node;
                    this.respawnTime = -1;
                    this.grace = false;
                    this.score = 0;
                    this.lock = false;

                    // Initial position - somewhere in the middle of the grid
                    this.node.x(PLAYGROUND_WIDTH/2-(PLAYGROUND_WIDTH/2%tileW)+tileW/2-playerW/2);
                    this.node.y(PLAYGROUND_HEIGHT/2-(PLAYGROUND_HEIGHT/2%tileH)+tileH/2-playerH/2);

                    this.addPoints=function(pts){
                        this.score += pts;
                        $('#currentScore').html(this.score);
                    };

                    this.moveTo = function(newx,newy){
                        if(newx >= 0 && newx <= PLAYGROUND_WIDTH && newx != this.node.x()){
                            if (!$('#pacman').collision('#tilemap,#tilemap div.gQ_tileType_1',{x:newx}).length)
                            {
                                this.lock = true;
                                $({x:that.node.x()}).animate({x:newx},{duration: STEP_SPEEDX, step: function(step){
                                    that.node.x(step);
                                    if (that.node.x() == newx)
                                    {
                                        that.lock = false;
                                    }
                                }});
                            }
                            else
                            {
                                console.log('Can\'t move right/left due to tile:'+$('#pacman').collision('#tilemap,#tilemap div.gQ_tileType_1',{x:newx})[0].id);
                            }
                        }
                        if (newy >= 0 && newy <= PLAYGROUND_HEIGHT && newy != this.node.y()){
                            if (!$('#pacman').collision('#tilemap,#tilemap div.gQ_tileType_1',{y:newy}).length)
                            {
                                this.lock = true;
                                $({y:that.node.y()}).animate({y:newy},{duration: STEP_SPEEDY, step: function(step){
                                    that.node.y(step);
                                    if (that.node.y() == newy)
                                    {
                                        that.lock = false;
                                    }
                                }});
                            }
                            else
                            {
                                console.log('Can\'t move up/down due to tile:'+$('#pacman').collision('#tilemap,#tilemap div.gQ_tileType_1',{y:newy})[0].id);
                            }
                        }
                    }

                    return true;
                }

                function Ghost(node){
                    var that = this;
                    this.node = node;
                    this.route = ghost0route;
                    this.lock = false;

                    // Initial position
                    this.node.x(plotXFromTile(parseInt(this.route[0].split("X")[0])));
                    this.node.y(plotYFromTile(parseInt(this.route[0].split("X")[1])));
                    // Removing the position we just consumed
                    this.route.shift();

                    // updates the position of the enemy
                    this.updateOne = function(playerNode){
                        if (this.route.length && !this.lock)
                        {
                            this.lock = true;
                            this.updateX(playerNode);
                            this.updateY(playerNode);
                        }
                    };    
                      
                    this.updateX = function(playerNode){
                        var nextposx = plotXFromTile(parseInt(this.route[0].split("X")[0]));
                        if (nextposx != this.node.x())
                        {
                            // Animating it to its next position
                            $({x:that.node.x()}).animate(
                                {x:nextposx},
                                {
                                    duration: 150, 
                                    step: function(step){
                                        //console.log('Moving from '+that.node.x()+' towards ' + nextposx + ' at step ' + step + ', route arrays has '+that.route.length+ ' elements');

                                        that.node.x(step);
                                        if (that.node.x() == nextposx)
                                        {
                                            if (that.lock)
                                            {
                                                that.lock = false;
                                                // Removing the position that's just been the object of the update
                                                that.route.shift();
                                            }
                                        }
                                    }
                                }
                            );
                        }
                    };
                    this.updateY= function(playerNode){
                        var nextposy = plotYFromTile(parseInt(this.route[0].split("X")[1]));
                        if (nextposy != this.node.y())
                        {
                            // Animating it to its next position
                            $({y:that.node.y()}).animate(
                                {y:nextposy},
                                {
                                    duration: 150, 
                                    step: function(step){
                                        //console.log('Moving from '+that.node.y()+' towards ' + nextposy + ' at step ' + step + ', route arrays has '+that.route.length+ ' elements');

                                        that.node.y(step);
                                        if (that.node.y() == nextposy)
                                        {
                                            if (that.lock)
                                            {
                                                that.lock = false;
                                                // Removing the position that's just been the object of the update
                                                that.route.shift();
                                            }
                                        }
                                    }
                                }
                            );
                        }
                    };

                    return true;
                }

                $.playground().registerCallback(function(){

                    var posx = player[0].player.node.x();
                    var posy = player[0].player.node.y();

                    $('#pacman').collision("#pacgums,#pacgums div").each(function(idx,pacgum){
                        //console.log("Collided with pacgum"+pacgum.id);
                        $('#'+pacgum.id).animate({opacity:0},100);
                        $('#'+pacgum.id).remove();

                        var ptsToAdd = 10;
                        if (pacgum.id.substr(0,6)=="coffee")
                        {
                            ptsToAdd = 50;
                        }
                        // Updating the score as well
                        player[0].player.addPoints(ptsToAdd);
                    });

                    //Update the movement of the player
                    if(!player[0].player.lock){
                      //$("#player")[0].player.update();
                      if(jQuery.gameQuery.keyTracker[65]){ //this is left! (a)
                        var nextpos = posx-SPEEDX;
                        player[0].player.moveTo(nextpos,posy);
                      }
                      if(jQuery.gameQuery.keyTracker[68]){ //this is right! (d)
                        var nextpos = posx+SPEEDX;
                        player[0].player.moveTo(nextpos,posy);
                      }
                      if(jQuery.gameQuery.keyTracker[87]){ //this is up! (w)
                        var nextpos = posy-SPEEDY;
                        player[0].player.moveTo(posx,nextpos);
                      }
                      if(jQuery.gameQuery.keyTracker[83]){ //this is down! (s)
                        var nextpos = posy+SPEEDY;
                        player[0].player.moveTo(posx,nextpos);
                      }
                    } else {
                        //player.css("top", ""+ posy +"px");
                        //player.css("left", ""+ posx +"px");
                    }

                    // Move the ghost
                    ghost0.updateOne();

                    }, REFRESH_RATE);
            });
        </script>
    </body>
</html>