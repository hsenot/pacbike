<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>PacBike</title>
        <style>
        </style>
    </head>
    <body>
        <div id="other stuff">
            Score:
            <div id="currentScore" style="display:inline-block;">
            </div>
            Date:
            <div id="currentDate" style="display:inline-block;">
            </div>
            Time:            
            <div id="currentTime" style="display:inline-block;">
            </div>
            Ghosts:            
            <div id="currentGhostNb" style="display:inline-block;">
            </div>
        </div>

        <div id="playground">
            <div id ="splash">
                <a id="start">Start</a>
                <div id="loadbar" style="background: 000; height: 32px; overflow: visible;"><span id="loadtext" style="color: red"></span></div>
            </div>
        </div>

        <script language="JavaScript" type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.js"></script>
        <script language="JavaScript" type="text/javascript" src="jquery.gamequery-0.7.1.js"></script>
        <script src="GSAP/src/minified/TweenMax.min.js"></script>
        <script src="GSAP/src/minified/jquery.gsap.min.js"></script>
        <script>
            var tileW = 30;
            var tileH = 30;
            var movingLock = false;
            var ghostRoutes, lastGhostIdx=0, ghostAnimArr;
            var ghost0route;

            var REFRESH_RATE = 30;
            // Number of minutes a refresh is representing (timer increment)
            var SIMULATED_TIME_RATE = 1;
            // Initial timer value
            var timer = 0;

            var playerHit = false;
            var playerW = 30;
            var playerH = 30;
            var player,allGhosts=new Array();
            var SPEEDX = tileW;
            var SPEEDY = tileH;
            // Duration (in ms) to get to the next tile
            // for the player
            var STEP_SPEEDX = 150;
            var STEP_SPEEDY = 150;
            // for the ghosts
            var GHOST_STEP_SPEEDX = 120;
            var GHOST_STEP_SPEEDY = 100;

            // Generated with gQ's Tiles map editor
            // http://gamequeryjs.com/tools/tilemapeditor/

            var animations = [];
            // Laneways
            animations[0] =  new $.gameQuery.Animation({
                imageURL:      'http://placehold.it/'+tileW+'/0B173B&text=.',
                type:          $.gameQuery.ANIMATION_ONCE,
                numberOfFrame: 1,
                delta:         0,
                rate:          1,
                offsetx:       0,
                offsety:       0
            });
            // Buildings
            animations[1] =  new $.gameQuery.Animation({
                imageURL:      'http://placehold.it/'+tileW+'/0000FF&text=.',
                type:          $.gameQuery.ANIMATION_ONCE,
                numberOfFrame: 1,
                delta:         0,
                rate:          1,
                offsetx:       0,
                offsety:       0
            });
            // Main arteries
            animations[2] =  new $.gameQuery.Animation({
                imageURL:      'http://placehold.it/'+tileW+'/000000&text=.',
                type:          $.gameQuery.ANIMATION_ONCE,
                numberOfFrame: 1,
                delta:         0,
                rate:          1,
                offsetx:       0,
                offsety:       0
            });
            // Bike stations
            animations[3] =  new $.gameQuery.Animation({
                imageURL:      'http://placehold.it/'+tileW+'/F7FE2E&text=.',
                type:          $.gameQuery.ANIMATION_ONCE,
                numberOfFrame: 1,
                delta:         0,
                rate:          1,
                offsetx:       0,
                offsety:       0
            });

             // the tilemap array
            var map = [
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2],
                        [3,2,1,2,2,2,1,2,2,3,1,2,1,2,2,2,2,2,3,1,1,1,1,2,2,2,3,2,1,2,2,2,1,2,1,3,2,2,2,2,2,2,2,2,3,2,2,2,2,2,2,2,2,3,1,2,2,1,2,1,2,2,3,2,2,2,1,2,2,3,3],
                        [3,2,1,2,2,2,1,1,1,3,1,1,1,2,1,2,2,2,3,1,2,1,1,2,2,2,3,1,1,1,1,1,1,1,1,3,2,2,2,2,2,2,1,1,3,2,2,2,2,2,2,2,2,3,1,2,1,1,2,1,1,2,3,2,2,1,1,2,2,2,3],
                        [3,2,2,2,2,1,1,1,2,3,2,1,1,2,1,2,1,2,3,1,1,1,1,2,1,2,3,2,2,1,1,1,1,2,1,3,4,2,2,2,2,1,1,2,3,2,2,2,2,2,2,2,2,3,1,2,1,1,2,1,1,2,3,2,2,1,2,2,2,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,2,2,2,1,2,1,3,2,1,2,1,2,1,1,2,3,2,2,2,2,2,2,2,3,2,1,2,1,1,1,1,1,3,2,2,2,2,2,1,1,2,3,4,1,1,2,1,1,1,1,3,1,2,2,2,2,1,2,2,3,2,2,2,1,1,1,1,3],
                        [3,2,2,2,2,2,1,2,2,3,1,1,2,1,1,1,1,2,3,2,2,1,1,1,2,2,3,1,1,2,1,1,1,1,2,3,2,2,2,2,2,1,1,1,3,1,1,1,1,1,1,1,1,3,1,2,2,2,2,1,2,2,3,2,2,2,2,1,2,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,2,1,2,2,2,2,3,1,2,1,2,2,2,2,2,3,2,2,2,2,2,2,1,3,2,1,1,1,1,1,2,2,3,2,1,2,2,2,2,1,2,3,2,1,2,2,2,1,1,2,3,2,2,1,2,2,2,1,2,3,2,1,1,2,2,2,2,3],
                        [3,1,1,1,1,2,1,2,2,3,1,1,1,2,2,2,2,2,3,2,2,2,2,2,2,1,3,2,1,1,1,2,1,1,1,3,1,1,2,2,1,2,1,2,3,1,1,2,1,1,1,1,2,3,1,2,1,1,2,1,1,2,3,2,2,1,2,1,1,2,3],
                        [3,1,2,2,2,1,1,1,2,3,1,1,1,2,1,2,2,2,3,2,2,2,2,2,2,1,3,2,2,1,1,2,1,1,2,3,2,1,2,2,1,2,1,2,3,2,1,2,1,2,1,1,2,3,2,2,1,1,2,1,2,2,3,1,1,1,2,1,1,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,2,2,2,1,1,2,3,1,2,2,1,1,2,1,2,3,1,2,1,1,3,1,2,3,2,2,1,1,1,1,1,1,3,2,2,1,2,1,1,2,1,3,1,1,1,1,1,1,1,2,3,1,1,1,1,1,2,1,1,3,2,1,1,2,1,2,2,3],
                        [3,2,2,2,2,2,1,1,2,3,1,2,2,1,1,2,1,2,3,1,2,2,2,3,1,1,3,2,1,1,1,2,1,1,1,3,4,2,1,2,1,1,2,1,3,1,1,1,1,1,2,1,1,3,1,1,1,1,1,2,1,4,3,1,1,1,2,1,1,1,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,1,2,2,2,2,2,2,3,2,1,2,2,1,2,2,2,3,2,2,2,4,3,2,1,3,2,2,1,2,2,2,2,2,3,2,2,1,1,1,2,2,2,3,2,2,2,1,1,2,4,2,3,2,2,2,2,2,1,2,2,3,2,1,1,2,1,1,2,3],
                        [3,2,1,2,2,2,2,2,2,3,2,1,2,2,1,2,2,2,3,2,2,1,2,3,2,1,3,2,1,1,2,2,2,2,2,3,1,1,1,1,1,1,2,1,3,1,2,2,1,1,1,1,1,3,1,2,1,2,2,1,2,2,3,2,1,1,1,1,1,2,3],
                        [3,2,1,2,2,2,2,2,2,3,2,1,2,2,1,2,2,2,3,2,2,1,2,3,2,2,3,2,1,1,2,2,1,2,2,3,2,1,1,1,1,1,2,1,3,1,1,1,1,1,2,1,2,3,1,2,1,2,2,1,2,2,3,2,1,1,2,1,1,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,2,2,2,2,2,2,3,2,2,1,1,2,1,1,2,3,2,1,1,2,1,1,1,3,2,2,1,1,2,1,1,2,3,1,1,1,2,1,1,1,1,3,1,1,1,1,2,2,2,2,3,2,1,2,1,1,1,2,2,3,1,1,2,1,1,1,1,3],
                        [3,1,1,1,1,1,1,1,4,3,2,2,1,1,1,1,1,1,3,2,1,2,1,1,2,1,3,2,2,2,2,2,2,1,1,3,2,1,1,2,1,1,1,1,3,2,2,2,1,2,2,2,2,3,2,1,2,1,2,2,2,2,3,2,1,2,1,1,2,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,2,2,2,2,2,2,3,2,2,2,2,2,2,2,2,3,2,2,4,3,2,2,1,3,2,2,2,2,2,2,2,2,3,2,2,2,1,2,1,2,2,3,2,2,1,2,2,2,2,2,3,2,2,1,2,2,2,1,1,3,2,2,2,2,1,2,2,3],
                        [3,2,2,2,2,2,2,2,2,3,2,2,2,2,2,2,2,2,3,2,2,1,3,2,1,1,3,1,1,2,1,1,2,2,1,3,2,2,2,1,2,1,2,1,3,2,2,1,1,1,2,2,2,3,1,2,1,2,2,1,1,2,3,2,2,2,2,1,1,4,3],
                        [3,2,2,2,2,2,2,2,2,3,1,2,2,2,2,2,2,2,3,2,2,1,3,1,1,1,3,2,1,2,1,2,2,1,1,3,2,2,2,1,1,1,2,1,3,2,2,1,1,1,2,1,2,3,2,2,1,2,2,2,1,2,3,2,2,2,2,2,1,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,1,2,2,1,1,2,3,1,1,2,2,1,2,2,2,3,2,2,1,3,2,1,2,3,2,1,2,2,1,2,1,1,3,2,1,1,1,1,1,1,2,3,2,2,1,2,1,1,1,2,3,1,2,1,1,1,1,1,2,3,1,1,1,1,1,1,2,3],
                        [3,2,2,1,2,2,1,1,1,3,1,1,2,2,1,2,2,2,3,2,2,1,3,2,1,2,3,2,1,2,2,2,2,2,1,3,2,1,2,1,1,2,1,2,3,2,2,1,2,2,1,1,2,3,1,2,1,2,2,2,1,1,3,2,2,2,1,2,2,1,3],
                        [3,2,2,1,2,2,1,2,2,3,2,1,2,2,1,2,2,2,3,2,2,1,3,2,1,2,3,2,1,2,2,2,2,2,1,3,2,1,2,1,1,2,1,2,3,4,2,1,2,2,1,1,2,3,1,2,1,2,2,2,1,1,3,2,2,2,1,2,2,1,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]
                    ];

            // Calculating board size based on the tilemap
            var tileNbX = map[0].length;
            var tileNbY = map.length;
            var PLAYGROUND_WIDTH    = tileNbX * tileW;
            var PLAYGROUND_HEIGHT   = tileNbY * tileH;

            // Let the game begin!
            var pacman = new $.gameQuery.Animation({imageURL: "images/pacman-small.png"});


            // My own wall collision detection function
            var collisionDetect = function(x,y,animationCode){
                var cellx = Math.round(((x+PLAYGROUND_WIDTH/2)*tileNbX)/PLAYGROUND_WIDTH)-1;
                var celly = Math.round(((y+PLAYGROUND_HEIGHT/2)*tileNbY)/PLAYGROUND_HEIGHT);
                // Mapping x and y to a map tile
                console.log("Collision detection with ("+cellx+","+celly+"):"+(map[celly][cellx] == animationCode));
                return map[celly][cellx] == animationCode;
            };

            //
            var plotXFromTile = function(colX){
                var pixel_x = parseInt(colX)*tileW;
                return pixel_x;
            }

            var plotYFromTile = function(rowY){
                var pixel_y = parseInt(rowY)*tileH;
                return pixel_y;
            }

            // Pointers to current date / time markers
            var currentDateDisplay = $('#currentDate');
            currentDateDisplay.html("...");
            var currentTimeDisplay = $('#currentTime');
            currentTimeDisplay.html("...");

            var dt;
            var displayTime = function(offsetInMn){
                if (!dt)
                {
                    var fts = ghostRoutes[0].s;
                    dt = new Date(fts.substring(0,4),fts.substring(5,7),fts.substring(8,10),fts.substring(11,13),fts.substring(14,16),fts.substring(17,19));
                }
                // Applying the offset
                dt.setMinutes(dt.getMinutes()+offsetInMn);

                // Displaying it
                var minutesStr = dt.getMinutes();
                if (minutesStr<10){minutesStr = "0"+minutesStr;}
                var hoursStr = dt.getHours();
                if (hoursStr<10){hoursStr = "0"+hoursStr;}

                currentDateDisplay.html(dt.getDate()+"/"+dt.getMonth()+1+"/"+dt.getFullYear());
                currentTimeDisplay.html(hoursStr+":"+minutesStr);
            }

            var currentGhostNb = 0;
            var currentGhostNbDisplay = $('#currentGhostNb');            
            var displayGhostsInPlay = function(nb){
                currentGhostNb += nb; 
                currentGhostNbDisplay.html(currentGhostNb); 
            }

            // Configuring the playground
            $('#playground').playground({
                    height: PLAYGROUND_HEIGHT, 
                    width: PLAYGROUND_WIDTH, 
                    keyTracker: true
                })
                .addTilemap("tilemap", map,  animations, {
                    width: tileW, 
                    height: tileH, 
                    sizex: tileNbX, 
                    sizey: tileNbY
                }).end()
                .addGroup("bikestations", {
                    width: PLAYGROUND_WIDTH, 
                    height: PLAYGROUND_HEIGHT
                }).end()
                .addGroup("pacgums", {
                    width: PLAYGROUND_WIDTH, 
                    height: PLAYGROUND_HEIGHT
                }).end()
                .addGroup("actors",{
                    width: PLAYGROUND_WIDTH, 
                    height: PLAYGROUND_HEIGHT
                })
                    .addGroup("player",{
                        width: playerW, 
                        height: playerH
                    }).end()
                    .addGroup("ghosts",{
                        width: playerW, 
                        height: playerH
                    }).end()
                .end();

            
            // configure the loading bar
            $.loadCallback(function(percent){
                $("#loadBar").width(400*percent);
                $("#loadtext").html(""+percent+"%")
            });
            
            // register the start button and remove the splash screen once the game is ready to starts
            $("#start").click(function(){
                // Game initialisation routine
                var gameInit = function(){
                    $("#splash").remove();

                    // Display the time
                    var firstOffsetMn = parseInt(ghostRoutes[0].o);
                    displayTime(-firstOffsetMn);

                    $("#player").addSprite("pacman", {
                        animation: pacman,
                        posx: 0,
                        posy: 0,
                        width: playerW, 
                        height: playerH
                    });

                    ghostAnimArr = {
                        "green": new $.gameQuery.Animation({imageURL: "images/ghost-small-green.png"}),
                        "orange": new $.gameQuery.Animation({imageURL: "images/ghost-small-orange.png"}),
                        "red": new $.gameQuery.Animation({imageURL: "images/ghost-small-red.png"})
                    };

                    // Positionning the pacgums
                    var pacgum = new $.gameQuery.Animation({imageURL: "images/apple-small.png"});
                    var coffee = new $.gameQuery.Animation({imageURL: "images/coffeecup-small.png"});

                    for (var j=0; j < tileNbY ; j+=1)
                    {
                        for (var i=0; i < tileNbX ; i+=1)
                        {
                            if (map[j][i] == 3 && ((i+j)%3==0))
                            {
                                if (Math.random()>0.8){
                                    $("#pacgums").addSprite("coffee-"+i+"_"+j, {
                                        animation: coffee,
                                        posx: (i+1/2)*tileW-25/2, 
                                        posy: (j+1/2)*tileH-24/2,
                                        width: 25,
                                        height: 24
                                    });
                                }
                                else
                                {
                                    $("#pacgums").addSprite("pacgum-"+i+"_"+j, {
                                        animation: pacgum,
                                        posx: (i+1/2)*tileW-20/2, 
                                        posy: (j+1/2)*tileH-20/2,
                                        width: 20,
                                        height: 20
                                    });
                                }
                            }
                        }
                    }

                    $("#player")[0].player = new Player($("#player"));
                    player = $("#player");

                };
                
                var releaseGhosts = function(currentTimer){
                    if (lastGhostIdx >= ghostRoutes.length)
                    {
                        alert("All ghosts have been released!");
                    }

                    // Releasing the ghosts
                    for (var j=lastGhostIdx;j<Object.keys(ghostRoutes).length;j++)
                    {
                        if (parseInt(ghostRoutes[j].o) < currentTimer)
                        {
                            // Duration of trips: short / medium / long
                            var tripDuration = parseInt(ghostRoutes[j].d);

                            if (tripDuration < 20)
                            {ghost = ghostAnimArr["green"];}
                            else if (tripDuration < 40)
                            {ghost = ghostAnimArr["orange"];}
                            else
                            {ghost = ghostAnimArr["red"];}

                            // Release the ghost!
                            $("#ghosts").addSprite("ghost"+j, {
                                animation: ghost,
                                posx: 0, 
                                posy: 0,
                                width: playerW, 
                                height: playerH
                            });

                            ghost0route = ghostRoutes[j+""].l.split(",");
                            $("#ghost"+j)[0].ghost = new Ghost($("#ghost"+j),ghost0route);
                            allGhosts[j] = $("#ghost"+j)[0].ghost;

                            // Incrementing the last released ghist index
                            lastGhostIdx++;
                            displayGhostsInPlay(1);
                        }
                        else
                        {
                            break;
                        }
                    }
                }

                // Loading the asset file where the ghosts routes are
                $.getJSON("routed_events/assets.json",
                    {},
                    function(json){
                        //
                        if (json)
                        {
                            // Now moving to the detail page with this task id
                            console.log('Asset JSON file loaded: ' + Object.keys(json).length + ' events.');
                            // Global variable holding the routes
                            ghostRoutes = json;
                            // Game init routine
                            $.playground().startGame(gameInit);
                        }
                    }
                );

                function Player(node){
                    var that = this;
                    this.node = node;
                    this.respawnTime = -1;
                    this.grace = false;
                    this.score = 0;
                    this.lock = false;

                    // Initial position - somewhere in the middle of the grid
                    this.node.x(PLAYGROUND_WIDTH/2-(PLAYGROUND_WIDTH/2%tileW)+tileW/2-playerW/2);
                    this.node.y(PLAYGROUND_HEIGHT/2-(PLAYGROUND_HEIGHT/2%tileH)+tileH/2-playerH/2);

                    this.addPoints=function(pts){
                        this.score += pts;
                        $('#currentScore').html(this.score);
                    };

                    this.moveTo = function(newx,newy){
                        //console.log('Moving from:'+this.node.x()+','+this.node.y()+' to '+newx+','+newy);

                        if(newx >= 0 && newx <= PLAYGROUND_WIDTH && newx != this.node.x()){
                            if (!player.collision('#tilemap,#tilemap div.gQ_tileType_1',{x:newx}).length)
                            {
                                //console.log('Moving to tile:'+$('#player').collision('#tilemap,#tilemap div.gQ_tileType_2',{x:newx})[0].id+' ('+$('#player').collision('#tilemap,#tilemap div',{x:newx}).length+' tiles detected)');

                                this.lock = true;
                                this.node.animate({x:newx}, 
                                    {
                                        duration:STEP_SPEEDX, 
                                        complete:function(){
                                            that.lock = false;
                                            that.node.x(newx);
                                        }
                                    }
                                );
                            }
                            else
                            {
                                //console.log('Can\'t move right/left due to tile:'+$('#pacman').collision('#tilemap,#tilemap div.gQ_tileType_1',{x:newx})[0].id);
                            }
                        }
                        if (newy >= 0 && newy <= PLAYGROUND_HEIGHT && newy != this.node.y()){
                            if (!player.collision('#tilemap,#tilemap div.gQ_tileType_1',{y:newy}).length)
                            {
                                //console.log('Moving to tile:'+$('#player').collision('#tilemap,#tilemap div.gQ_tileType_2',{y:newy})[0].id+' ('+$('#player').collision('#tilemap,#tilemap div',{y:newy}).length+' tiles detected)');

                                this.lock = true;
                                this.node.animate({y:newy}, 
                                    {
                                        duration:STEP_SPEEDY, 
                                        complete:function(){
                                            that.lock = false;
                                            that.node.y(newy);
                                        }
                                    }
                                );                            }
                            else
                            {
                                //console.log('Can\'t move up/down due to tile:'+$('#player').collision('#tilemap,#tilemap div.gQ_tileType_1',{y:newy})[0].id);
                            }
                        }
                    }

                    return true;
                }

                function Ghost(node,route,duration){
                    var that = this;
                    this.node = node;
                    this.route = route;
                    this.tripDuration = 
                    this.lock = false;

                    // Initial position
                    this.node.x(plotXFromTile(parseInt(this.route[0].split("X")[0])));
                    this.node.y(plotYFromTile(parseInt(this.route[0].split("X")[1])));
                    // Removing the position we just consumed
                    this.route.shift();

                    // updates the position of the enemy
                    this.updateOne = function(playerNode){
                        if (this.route.length && !this.lock)
                        {
                            this.lock = true;
                            this.updateX(playerNode);
                            this.updateY(playerNode);
                        }

                        // If we arrived at the end of the route, we need to destroy the ghost and remove it from the ghost array
                        if (!this.route.length)
                        {
                            this.node.animate({opacity:0},100);

                            var ghostIdx = allGhosts.indexOf(this);
                            if (ghostIdx>-1)
                            {
                                allGhosts.splice(ghostIdx,1);
                            }

                            // Removing the sprite from the DOM / gQ group
                            this.node.remove();
                            // Updating the numerical display of ghost numbers
                            displayGhostsInPlay(-1);
                        }
                    };    
                      
                    this.updateX = function(playerNode){
                        var nextposx = plotXFromTile(parseInt(this.route[0].split("X")[0]));
                        if (nextposx != this.node.x())
                        {
                            this.node.animate({x:nextposx}, 
                                {
                                    duration:GHOST_STEP_SPEEDX+(Math.random()*0.5-0.25)*GHOST_STEP_SPEEDX, 
                                    complete:function(){
                                        if (that.lock)
                                        {
                                            that.lock = false;
                                            // Removing the position that's just been the object of the update
                                            that.route.shift();                                            
                                        }
                                    }
                                }
                            );
                        }
                    };
                    this.updateY= function(playerNode){
                        var nextposy = plotYFromTile(parseInt(this.route[0].split("X")[1]));
                        if (nextposy != this.node.y())
                        {
                            this.node.animate({y:nextposy}, 
                                {
                                    duration:GHOST_STEP_SPEEDY+(Math.random()*0.5-0.25)*GHOST_STEP_SPEEDY, 
                                    complete:function(){
                                        if (that.lock)
                                        {
                                            that.lock = false;
                                            // Removing the position that's just been the object of the update
                                            that.route.shift();                                            
                                        }
                                    }
                                }
                            );
                        }
                    };

                    return true;
                }

                $.playground().registerCallback(function(){
                    timer += SIMULATED_TIME_RATE;
                    releaseGhosts(timer);
                    displayTime(SIMULATED_TIME_RATE);

                    var posx = player[0].player.node.x();
                    var posy = player[0].player.node.y();

                    player.collision("#pacgums,#pacgums div").each(function(idx,pacgum){
                        //console.log("Collided with pacgum"+pacgum.id);
                        $('#'+pacgum.id).animate({opacity:0},100);
                        $('#'+pacgum.id).remove();

                        var ptsToAdd = 10;
                        if (pacgum.id.substr(0,6)=="coffee")
                        {
                            ptsToAdd = 50;
                        }
                        // Updating the score as well
                        player[0].player.addPoints(ptsToAdd);
                    });

                    //Update the movement of the player
                    if(!player[0].player.lock){
                      //$("#player")[0].player.update();
                      if(jQuery.gameQuery.keyTracker[65]){ //this is left! (a)
                        var nextpos = posx-SPEEDX;
                        player[0].player.moveTo(nextpos,posy);
                      }
                      if(jQuery.gameQuery.keyTracker[68]){ //this is right! (d)
                        var nextpos = posx+SPEEDX;
                        player[0].player.moveTo(nextpos,posy);
                      }
                      if(jQuery.gameQuery.keyTracker[87]){ //this is up! (w)
                        var nextpos = posy-SPEEDY;
                        player[0].player.moveTo(posx,nextpos);
                      }
                      if(jQuery.gameQuery.keyTracker[83]){ //this is down! (s)
                        var nextpos = posy+SPEEDY;
                        player[0].player.moveTo(posx,nextpos);
                      }
                    } else {
                        //player.css("top", ""+ posy +"px");
                        //player.css("left", ""+ posx +"px");
                    }

                    // Move the ghost
                    for (var j=0;j<allGhosts.length;j++)
                    {
                        if (allGhosts[j])
                        {
                            allGhosts[j].updateOne();
                        } 
                    }

                    }, REFRESH_RATE);
            });
        </script>
    </body>
</html>