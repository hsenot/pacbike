<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>PacBike</title>
        <style>
        </style>
    </head>
    <body>
        <div id="playground">
            <div id ="splash">
                <a id="start">Start</a>
                <div id="loadbar" style="background: 000; height: 32px; overflow: visible;"><span id="loadtext" style="color: red"></span></div>
            </div>
        </div>

        <script language="JavaScript" type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.js"></script>
        <script language="JavaScript" type="text/javascript" src="jquery.gamequery-0.7.1.js"></script>
        <script>
            var tileW = 30;
            var tileH = 30;
            var movingLock = false;

            var REFRESH_RATE = 30;
            var playerHit = false;
            var playerW = 30;
            var playerH = 30;
            var player;
            var SPEEDX = tileW;
            var SPEEDY = tileH;
            // Duration (in ms) to get to the next tile
            var STEP_SPEEDX = 200;
            var STEP_SPEEDY = 200;

            // Generated with gQ's Tiles map editor
            // http://gamequeryjs.com/tools/tilemapeditor/

            var animations = [];
            // Laneways
            animations[0] =  new $.gameQuery.Animation({
                imageURL:      'http://placehold.it/'+tileW+'/0B173B&text=.',
                type:          $.gameQuery.ANIMATION_ONCE,
                numberOfFrame: 1,
                delta:         0,
                rate:          1,
                offsetx:       0,
                offsety:       0
            });
            // Buildings
            animations[1] =  new $.gameQuery.Animation({
                imageURL:      'http://placehold.it/'+tileW+'/0000FF&text=.',
                type:          $.gameQuery.ANIMATION_ONCE,
                numberOfFrame: 1,
                delta:         0,
                rate:          1,
                offsetx:       0,
                offsety:       0
            });
            // Main arteries
            animations[2] =  new $.gameQuery.Animation({
                imageURL:      'http://placehold.it/'+tileW+'/000000&text=.',
                type:          $.gameQuery.ANIMATION_ONCE,
                numberOfFrame: 1,
                delta:         0,
                rate:          1,
                offsetx:       0,
                offsety:       0
            });

             // the tilemap array
            var map = [
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2],
                        [3,2,1,2,2,2,1,2,2,3,1,2,1,2,2,2,2,2,3,1,1,1,1,2,2,2,3,2,1,2,2,2,1,2,1,3,2,2,2,2,2,2,2,2,3,2,2,2,2,2,2,2,2,3,1,2,2,1,2,1,2,2,3,2,2,2,1,2,2,3,3],
                        [3,2,1,2,2,2,1,1,1,3,1,1,1,2,1,2,2,2,3,1,2,1,1,2,2,2,3,1,1,1,1,1,1,1,1,3,2,2,2,2,2,2,1,1,3,2,2,2,2,2,2,2,2,3,1,2,1,1,2,1,1,2,3,2,2,1,1,2,2,2,3],
                        [3,2,2,2,2,1,1,1,2,3,2,1,1,2,1,2,1,2,3,1,1,1,1,2,1,2,3,2,2,1,1,1,1,2,1,3,2,2,2,2,2,1,1,2,3,2,2,2,2,2,2,2,2,3,1,2,1,1,2,1,1,2,3,2,2,1,2,2,2,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,2,2,2,1,2,1,3,2,1,2,1,2,1,1,2,3,2,2,2,2,2,2,2,3,2,1,2,1,1,1,1,1,3,2,2,2,2,2,1,1,2,3,1,1,1,2,1,1,1,1,3,1,2,2,2,2,1,2,2,3,2,2,2,1,1,1,1,3],
                        [3,2,2,2,2,2,1,2,2,3,1,1,2,1,1,1,1,2,3,2,2,1,1,1,2,2,3,1,1,2,1,1,1,1,2,3,2,2,2,2,2,1,1,1,3,1,1,1,1,1,1,1,1,3,1,2,2,2,2,1,2,2,3,2,2,2,2,1,2,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,2,1,2,2,2,2,3,1,2,1,2,2,2,2,2,3,2,2,2,2,2,2,1,3,2,1,1,1,1,1,2,2,3,2,1,2,2,2,2,1,2,3,2,1,2,2,2,1,1,2,3,2,2,1,2,2,2,1,2,3,2,1,1,2,2,2,2,3],
                        [3,1,1,1,1,2,1,2,2,3,1,1,1,2,2,2,2,2,3,2,2,2,2,2,2,1,3,2,1,1,1,2,1,1,1,3,1,1,2,2,1,2,1,2,3,1,1,2,1,1,1,1,2,3,1,2,1,1,2,1,1,2,3,2,2,1,2,1,1,2,3],
                        [3,1,2,2,2,1,1,1,2,3,1,1,1,2,1,2,2,2,3,2,2,2,2,2,2,1,3,2,2,1,1,2,1,1,2,3,2,1,2,2,1,2,1,2,3,2,1,2,1,2,1,1,2,3,2,2,1,1,2,1,2,2,3,1,1,1,2,1,1,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,2,2,2,1,1,2,3,1,2,2,1,1,2,1,2,3,1,2,1,1,1,1,2,3,2,2,1,1,1,1,1,1,3,2,2,1,2,1,1,2,1,3,1,1,1,1,1,1,1,2,3,1,1,1,1,1,2,1,1,3,2,1,1,2,1,2,2,3],
                        [3,2,2,2,2,2,1,1,2,3,1,2,2,1,1,2,1,2,3,1,2,2,2,1,1,1,3,2,1,1,1,2,1,1,1,3,2,2,1,2,1,1,2,1,3,1,1,1,1,1,2,1,1,3,1,1,1,1,1,2,1,1,3,1,1,1,2,1,1,1,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,1,2,2,2,2,2,2,3,2,1,2,2,1,2,2,2,3,2,2,2,2,1,2,1,3,2,2,1,2,2,2,2,2,3,2,2,1,1,1,2,2,2,3,2,2,2,1,1,2,2,2,3,2,2,2,2,2,1,2,2,3,2,1,1,2,1,1,2,3],
                        [3,2,1,2,2,2,2,2,2,3,2,1,2,2,1,2,2,2,3,2,2,1,2,1,2,1,3,2,1,1,2,2,2,2,2,3,1,1,1,1,1,1,2,1,3,1,2,2,1,1,1,1,1,3,1,2,1,2,2,1,2,2,3,2,1,1,1,1,1,2,3],
                        [3,2,1,2,2,2,2,2,2,3,2,1,2,2,1,2,2,2,3,2,2,1,2,1,2,2,3,2,1,1,2,2,1,2,2,3,2,1,1,1,1,1,2,1,3,1,1,1,1,1,2,1,2,3,1,2,1,2,2,1,2,2,3,2,1,1,2,1,1,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,2,2,2,2,2,2,3,2,2,1,1,2,1,1,2,3,2,1,1,2,1,1,1,3,2,2,1,1,2,1,1,2,3,1,1,1,2,1,1,1,1,3,1,1,1,1,2,2,2,2,3,2,1,2,1,1,1,2,2,3,1,1,2,1,1,1,1,3],
                        [3,1,1,1,1,1,1,1,1,3,2,2,1,1,1,1,1,1,3,2,1,2,1,1,2,1,3,2,2,2,2,2,2,1,1,3,2,1,1,2,1,1,1,1,3,2,2,2,1,2,2,2,2,3,2,1,2,1,2,2,2,2,3,2,1,2,1,1,2,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,2,2,2,2,2,2,3,2,2,2,2,2,2,2,2,3,2,2,1,1,2,2,1,3,2,2,2,2,2,2,2,2,3,2,2,2,1,2,1,2,2,3,2,2,1,2,2,2,2,2,3,2,2,1,2,2,2,1,1,3,2,2,2,2,1,2,2,3],
                        [3,2,2,2,2,2,2,2,2,3,2,2,2,2,2,2,2,2,3,2,2,1,1,2,1,1,3,1,1,2,1,1,2,2,1,3,2,2,2,1,2,1,2,1,3,2,2,1,1,1,2,2,2,3,1,2,1,2,2,1,1,2,3,2,2,2,2,1,1,2,3],
                        [3,2,2,2,2,2,2,2,2,3,1,2,2,2,2,2,2,2,3,2,2,1,1,1,1,1,3,2,1,2,1,2,2,1,1,3,2,2,2,1,1,1,2,1,3,2,2,1,1,1,2,1,2,3,2,2,1,2,2,2,1,2,3,2,2,2,2,2,1,2,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
                        [3,2,2,1,2,2,1,1,2,3,1,1,2,2,1,2,2,2,3,2,2,1,2,2,1,2,3,2,1,2,2,1,2,1,1,3,2,1,1,1,1,1,1,2,3,2,2,1,2,1,1,1,2,3,1,2,1,1,1,1,1,2,3,1,1,1,1,1,1,2,3],
                        [3,2,2,1,2,2,1,1,1,3,1,1,2,2,1,2,2,2,3,2,2,1,2,2,1,2,3,2,1,2,2,2,2,2,1,3,2,1,2,1,1,2,1,2,3,2,2,1,2,2,1,1,2,3,1,2,1,2,2,2,1,1,3,2,2,2,1,2,2,1,3],
                        [3,2,2,1,2,2,1,2,2,3,2,1,2,2,1,2,2,2,3,2,2,1,2,2,1,2,3,2,1,2,2,2,2,2,1,3,2,1,2,1,1,2,1,2,3,2,2,1,2,2,1,1,2,3,1,2,1,2,2,2,1,1,3,2,2,2,1,2,2,1,3],
                        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]
                    ];

            // Calculating board size based on the tilemap
            var tileNbX = map[0].length;
            var tileNbY = map.length;
            var PLAYGROUND_WIDTH    = tileNbX * tileW;
            var PLAYGROUND_HEIGHT   = tileNbY * tileH;

            // My own wall collision detection function
            var collisionDetect = function(x,y,animationCode){
                var cellx = Math.round(((x+PLAYGROUND_WIDTH/2)*tileNbX)/PLAYGROUND_WIDTH)-1;
                var celly = Math.round(((y+PLAYGROUND_HEIGHT/2)*tileNbY)/PLAYGROUND_HEIGHT);
                // Mapping x and y to a map tile
                console.log("Collision detection with ("+cellx+","+celly+"):"+(map[celly][cellx] == animationCode));
                return map[celly][cellx] == animationCode;
            };

            // Configuring the playground
            $('#playground').playground({
                    height: PLAYGROUND_HEIGHT, 
                    width: PLAYGROUND_WIDTH, 
                    keyTracker: true
                })
                .addTilemap("tilemap", map,  animations, {
                    width: tileW, 
                    height: tileH, 
                    sizex: tileNbX, 
                    sizey: tileNbY
                }).end()
                .addGroup("bikestations", {
                    width: PLAYGROUND_WIDTH, 
                    height: PLAYGROUND_HEIGHT
                }).end()
                .addGroup("pacgums", {
                    width: PLAYGROUND_WIDTH, 
                    height: PLAYGROUND_HEIGHT
                }).end()
                .addGroup("actors",{
                    width: PLAYGROUND_WIDTH, 
                    height: PLAYGROUND_HEIGHT
                })
                    .addGroup("player",{
                        width: playerW, 
                        height: playerH
                    }).end()
                .end();

            
            // configure the loading bar
            $.loadCallback(function(percent){
                $("#loadBar").width(400*percent);
                $("#loadtext").html(""+percent+"%")
            });
            
            // register the start button and remove the splash screen once the game is ready to starts
            $("#start").click(function(){
                $.playground().startGame(function(){
                    $("#splash").remove();

                    // Let the game begin!
                    var pacman = new $.gameQuery.Animation({imageURL: "images/pacman-small.png"});

                    $("#player").addSprite("pacman", {
                        animation: pacman,
                        posx: PLAYGROUND_WIDTH/2-(PLAYGROUND_WIDTH/2%tileW)+tileW/2-playerW/2, 
                        posy: PLAYGROUND_HEIGHT/2-(PLAYGROUND_HEIGHT/2%tileH)+tileH/2-playerH/2,
                        width: playerW, 
                        height: playerH
                    });

                    // Positionning the pacgums
                    var pacgum = new $.gameQuery.Animation({imageURL: "images/apple-small.png"});
                    for (var j=0; j < tileNbY ; j+=1)
                    {
                        for (var i=0; i < tileNbX ; i+=1)
                        {
                            if (map[j][i] == 3 && ((i+j)%3==0))
                            {
                                $("#pacgums").addSprite("pacgum", {
                                    animation: pacgum,
                                    posx: (i+1/2)*tileW-20/2, 
                                    posy: (j+1/2)*tileH-20/2,
                                    width: 20,
                                    height: 20
                                });
                            }
                        }
                    }

                });

                function Player(node){
                    this.node = node;
                    this.respawnTime = -1;
                    this.grace = false;
                        
                    return true;
                }

                $("#player")[0].player = new Player($("#player"));
                player = $("#player");

                $.playground().registerCallback(function(){

                    var posx = player.x();
                    var posy = player.y();

                    //Update the movement of the player
                    // Should that be done using a queue? so that PacMan is more "gliding"?
                    if(!movingLock){
                      //$("#player")[0].player.update();
                      if(jQuery.gameQuery.keyTracker[65]){ //this is left! (a)
                        var nextpos = posx-SPEEDX;
                        if(nextpos >= -PLAYGROUND_WIDTH/2 + playerW/2){
                            if (!collisionDetect(nextpos,posy,2))
                            {
                                movingLock = true;
                                $({x:posx}).animate({x:nextpos},{duration: STEP_SPEEDX, step: function(step){
                                    player.x(step);
                                    if (player.x() == nextpos)
                                    {
                                        movingLock = false;
                                    }
                                }});
                            }
                        }
                      }
                      if(jQuery.gameQuery.keyTracker[68]){ //this is right! (d)
                        var nextpos = posx+SPEEDX;
                        if(nextpos <= PLAYGROUND_WIDTH/2 - playerW/2){
                            if (!collisionDetect(nextpos,posy,2))
                            {
                                movingLock = true;
                                $({x:posx}).animate({x:nextpos},{duration: STEP_SPEEDX, step: function(step){
                                    player.x(step);
                                    if (player.x() == nextpos)
                                    {
                                        movingLock = false;
                                    }
                                }});
                            }
                        }
                      }
                      if(jQuery.gameQuery.keyTracker[87]){ //this is up! (w)
                        var nextpos = posy-SPEEDY;
                        if(nextpos >= -PLAYGROUND_HEIGHT/2){
                            if (!collisionDetect(posx,nextpos,2))
                            {
                                movingLock = true;
                                $({y:posy}).animate({y:nextpos},{duration: STEP_SPEEDY, step: function(step){
                                    player.y(step);
                                    if (player.y() == nextpos)
                                    {
                                        movingLock = false;
                                    }
                                }});
                            }
                        }
                      }
                      if(jQuery.gameQuery.keyTracker[83]){ //this is down! (s)
                        var nextpos = posy+SPEEDY;
                        if(nextpos < PLAYGROUND_HEIGHT/2 - playerH/2){
                            if (!collisionDetect(posx,nextpos,2))
                            {
                                movingLock = true;
                                $({y:posy}).animate({y:nextpos},{duration: STEP_SPEEDY, step: function(step){
                                    player.y(step);
                                    if (player.y() == nextpos)
                                    {
                                        movingLock = false;
                                    }
                                }});
                            }
                        }
                      }
                    } else {
                        //player.css("top", ""+ posy +"px");
                        //player.css("left", ""+ posx +"px");
                      }
                    }, REFRESH_RATE);

            });
        </script>
    </body>
</html>